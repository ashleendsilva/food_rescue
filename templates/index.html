<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Food Save & Share</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #fdfdfd;
      color: #050505;
    }
    header {
      background: #1e3932;
      padding: 15px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #fff5f5;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    header h1 { margin: 0; font-size: 22px; }
    nav a {
      margin: 0 15px;
      color: rgba(239,229,229,0.7);
      text-decoration: none;
      font-weight: 500;
    }
    nav a:hover { color: #f4b400; }
    section { padding: 60px 20px; display: none; }
    section.active { display: block; }
    /* Hero */
    .hero {
      height: 90vh;
      text-align: center;
      background: url('https://images.unsplash.com/photo-1504754524776-8f4f37790ca0?auto=format&fit=crop&w=1200&q=80') no-repeat center/cover;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 40px;
    }
    .hero h1 { font-size: 50px; color: #fff; text-shadow: 2px 2px 6px rgba(0,0,0,0.6); }
    .hero p { font-size: 20px; max-width: 600px; margin: 20px auto; color: #fff; text-shadow: 1px 1px 4px rgba(0,0,0,0.6); }
    .cards {
      display: flex; justify-content: center; flex-wrap: wrap; gap: 25px; margin-top: 40px;
    }
    .card {
      background: white; border-radius: 12px; width: 280px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      text-align: center; padding: 20px; cursor: pointer;
      transition: transform 0.2s;
    }
    .card:hover { transform: translateY(-5px); }
    .card img {
      width: 100%; height: 160px; border-radius: 10px; object-fit: cover;
    }
    .card h3 { margin-top: 10px; color: #1e3932; }
    /* Food gallery */
    .food-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px; 
      margin-top: 25px;
    }
    .food-card {
      background: #fff; 
      padding: 20px; 
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1); 
      text-align: center;
      border: 1px solid #e0e0e0;
    }
    .food-card img {
      width: 100%; height: 180px; border-radius: 10px; object-fit: cover;
      margin-bottom: 10px;
    }
    .food-card h3 {
      margin: 15px 0 10px 0;
      color: #1e3932;
      font-size: 18px;
      font-weight: 600;
    }
    .food-card p {
      margin: 8px 0;
      color: #555;
      line-height: 1.5;
    }
    .food-card .quantity {
      font-weight: 600;
      color: #f4b400;
      font-size: 16px;
    }
    .food-card .contact {
      color: #1e3932;
      font-weight: 500;
    }
    .food-card .location {
      color: #666;
      font-style: italic;
    }
    /* Modal */
    .modal {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center;
      z-index: 2000;
    }
    .modal-content {
      background: #fff; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px;
      max-height: 90vh; overflow-y: auto;
      box-shadow: 0 4px 14px rgba(0,0,0,0.3); text-align: center; position: relative;
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn { from {opacity:0; transform:scale(0.9);} to {opacity:1; transform:scale(1);} }
    @keyframes shake { 0%, 100% {transform:translateX(0);} 25% {transform:translateX(-5px);} 75% {transform:translateX(5px);} }
    .modal-content h2 { margin-bottom: 20px; }
    .modal-content h3 { 
      margin: 25px 0 15px 0; 
      color: #1e3932; 
      font-size: 20px;
      border-bottom: 2px solid #f4b400;
      padding-bottom: 8px;
    }
    .modal-content input, .modal-content textarea, .modal-content button {
      width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px;
      border: 1px solid #ccc; font-size: 15px; box-sizing: border-box;
    }
    .modal-content button {
      background: #f4b400; color: #1e3932; font-weight: bold; border: none; cursor: pointer; transition: 0.2s;
    }
    .modal-content button:hover { background: #e19e00; }
    .modal-content button:disabled { 
      background: #ccc; cursor: not-allowed; 
    }
    
    .close-btn {
      position: absolute; top: 10px; right: 15px; font-size: 20px; cursor: pointer; color: #333;
    }
    
    /* Error/Success message styling */
    .message {
      font-size: 14px;
      margin: 10px 0;
      text-align: center;
      display: none;
      padding: 12px;
      border-radius: 6px;
      font-weight: 500;
    }
    
    .error-message {
      color: #dc3545;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
    }
    
    .password-error {
      color: #dc3545;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      font-size: 13px;
      margin: 5px 0;
      text-align: center;
      padding: 8px;
      border-radius: 4px;
      font-weight: 600;
    }
    
    .contact-error {
      color: #dc3545;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      font-size: 13px;
      margin: 5px 0;
      text-align: center;
      padding: 8px;
      border-radius: 4px;
      font-weight: 600;
    }
    
    .success-message {
      color: #155724;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
    }
    
    .info-message {
      color: #004085;
      background-color: #cce7ff;
      border: 1px solid #99d3ff;
    }
    
    .input-error {
      border-color: #dc3545 !important;
    }
    
    /* Button container for login/signup */
    .button-container {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    .button-container button {
      flex: 1;
    }
    
    .login-btn {
      background: #1e3932 !important;
      color: #fff !important;
    }
    
    .login-btn:hover {
      background: #2a4a3f !important;
    }
    
    /* Password fields for signup only */
    .password-fields {
      display: block;
    }
    
    .login-mode .password-fields {
      display: none;
    }

    .loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .no-food-message {
      text-align: center;
      color: #666;
      font-style: italic;
      padding: 40px 20px;
      background: #f9f9f9;
      border-radius: 8px;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <header>
    <h1>üç≤ Food Save & Share</h1>
    <nav>
      <a href="#" onclick="showSection('home')">Home</a>
      <a href="#" onclick="showSection('map-section')">Map</a>
    </nav>
  </header>

  <!-- Hero Section -->
  <section id="home" class="active hero">
    <h1>Save Food, Serve Humanity</h1>
    <p>Together, we can reduce food waste and help feed millions of hungry people.</p>
    <div class="cards">
      <div class="card" onclick="openModal('NGO')">
        <img src="https://images.unsplash.com/photo-1509099836639-18ba1795216d?auto=format&fit=crop&w=600&q=80" alt="NGO Volunteers">
        <h3>üë©‚Äçü§ù‚Äçüë© NGO Sign Up</h3>
        <p style="color:black;">Join hands with restaurants & distribute food to those in need.</p>
      </div>
      <div class="card" onclick="openModal('Restaurant')">
        <img src="https://images.unsplash.com/photo-1555396273-367ea4eb4db5?auto=format&fit=crop&w=600&q=80" alt="Restaurant Kitchen">
        <h3>üç¥ Restaurant Sign Up</h3>
        <p style="color:black;">List your extra food & reduce waste responsibly.</p>
      </div>
    </div>
  </section>

  <!-- Map -->
  <section id="map-section">
    <h2 style="text-align:center;">Nearby Restaurants & Food Pickup Points</h2>
    <iframe width="100%" height="400" style="border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); border:0;" loading="lazy" allowfullscreen
      src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3929.681569256033!2d74.8520!3d12.9141!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3ba35a3f7e9f77ff%3A0xabcdef123456789!2eMangalore!5e0!3m2!1sen!2sin!4v1694600000000!5m2!1sen!2sin">
    </iframe>
  </section>

  <!-- Signup/Login Modal -->
  <div id="signupModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close-btn" onclick="closeModal()">&times;</span>
      <h2 id="modalTitle">Sign Up</h2>

      <!-- Login/Signup Form -->
      <form id="authForm">
        <input type="text" id="fullName" placeholder="Full Name / Organization" required>
        <input type="email" id="email" placeholder="Email" required>
        <input type="tel" id="phone" placeholder="Phone" required maxlength="15">
        <div class="message contact-error" id="phoneError">‚ùå Please enter numbers only for phone</div>
        
        <div class="password-fields">
          <input type="password" id="password" placeholder="Password" required>
          <input type="password" id="confirmPassword" placeholder="Confirm Password" required>
          <div class="message password-error" id="passwordError">‚ùå Passwords do not match!</div>
        </div>
        
        <div class="message error-message" id="errorMessage"></div>
        <div class="message success-message" id="successMessage"></div>
        <div class="message info-message" id="infoMessage"></div>
        
        <div class="button-container">
          <button type="button" class="login-btn" onclick="handleLogin()">Login</button>
          <button type="submit">Sign Up</button>
        </div>
      </form>

      <!-- NGO Food Availability -->
      <div id="ngoFoodGallery" style="display:none; margin-top:20px;">
        <h3>Available Leftover Food</h3>
        <div class="food-gallery" id="ngoGalleryList">
          <!-- Food items will be dynamically inserted here -->
        </div>
      </div>

      <!-- Restaurant Food Listing -->
      <div id="restaurantForm" style="display:none; margin-top:20px;">
        <h3>List Your Extra Food</h3>
        <input type="text" id="foodTitle" placeholder="Food Title" required>
        <input type="text" id="foodQty" placeholder="Quantity (e.g. 5 Plates)" required>
        <input type="text" id="foodPickup" placeholder="Pickup Location" required>
        <input type="text" id="foodRestaurant" placeholder="Restaurant Name" required>
        <input type="tel" id="foodContact" placeholder="Contact Number" required maxlength="15">
        <div class="message contact-error" id="foodContactError">‚ùå Please enter numbers only for contact</div>
        <input type="url" id="foodImageUrl" placeholder="Image URL (optional)">
        <button type="button" onclick="addFood()">Add Food</button>

        <div class="food-gallery" id="restaurantFoodList" style="margin-top:20px;"></div>
      </div>
    </div>
  </div>

  <script>
    let currentRole = '';
    let isLoginMode = false;
    let currentUserId = null;



    function showSection(id) {
      document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function openModal(role) {
      currentRole = role;
      isLoginMode = false;
      document.getElementById("signupModal").style.display = "flex";
      document.getElementById("modalTitle").innerText = role + " Sign Up / Login";
      document.getElementById("ngoFoodGallery").style.display = "none";
      document.getElementById("restaurantForm").style.display = "none";
      document.body.style.overflow = "hidden";

      resetForm();
    }

    function closeModal() {
      document.getElementById("signupModal").style.display = "none";
      document.body.style.overflow = "auto";
      resetForm();
    }

    function resetForm() {
      document.getElementById("authForm").reset();
      hideAllMessages();
      document.getElementById("authForm").classList.remove("login-mode");
      isLoginMode = false;
    }

    function showMessage(messageId, text) {
      hideAllMessages();
      const element = document.getElementById(messageId);
      element.textContent = text;
      element.style.display = "block";
    }

    function hideAllMessages() {
      document.querySelectorAll('.message').forEach(msg => {
        msg.style.display = "none";
      });
      document.querySelectorAll('.input-error').forEach(input => {
        input.classList.remove('input-error');
      });
    }

    function showPasswordError() {
      const errorElement = document.getElementById("passwordError");
      errorElement.style.display = "block";
      errorElement.style.animation = "shake 0.5s ease-in-out";
      document.getElementById("password").classList.add("input-error");
      document.getElementById("confirmPassword").classList.add("input-error");
    }

    function hidePasswordError() {
      const errorElement = document.getElementById("passwordError");
      errorElement.style.display = "none";
      errorElement.style.animation = "none";
      document.getElementById("password").classList.remove("input-error");
      document.getElementById("confirmPassword").classList.remove("input-error");
    }

    function validatePasswords() {
      if (isLoginMode) return true;
      
      const password = document.getElementById("password").value;
      const confirmPassword = document.getElementById("confirmPassword").value;
      
      if (password !== confirmPassword) {
        showPasswordError();
        return false;
      } else {
        hidePasswordError();
        return true;
      }
    }

    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function validatePhoneNumber(phone) {
      // Check if phone contains only digits, spaces, hyphens, parentheses, and plus sign
      const phoneRegex = /^[\d\s\-\(\)\+]+$/;
      return phoneRegex.test(phone) && phone.replace(/[\s\-\(\)\+]/g, '').length >= 10;
    }

    function showPhoneError(fieldId, errorId) {
      const errorElement = document.getElementById(errorId);
      errorElement.style.display = "block";
      errorElement.style.animation = "shake 0.5s ease-in-out";
      document.getElementById(fieldId).classList.add("input-error");
    }

    function hidePhoneError(fieldId, errorId) {
      const errorElement = document.getElementById(errorId);
      errorElement.style.display = "none";
      errorElement.style.animation = "none";
      document.getElementById(fieldId).classList.remove("input-error");
    }

    function sanitizePhoneInput(input) {
      // Remove any non-numeric characters except +, -, (, ), and spaces
      return input.replace(/[^0-9\+\-\(\)\s]/g, '');
    }

    function containsAlphabets(input) {
      // Check if input contains any alphabetic characters
      return /[a-zA-Z]/.test(input);
    }

    function setLoading(loading) {
      const modal = document.querySelector('.modal-content');
      if (loading) {
        modal.classList.add('loading');
      } else {
        modal.classList.remove('loading');
      }
    }

    async function handleLogin() {
      isLoginMode = true;
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!email || !password) {
        showMessage("errorMessage", "Please fill in email and password to login.");
        return;
      }

      if (!validateEmail(email)) {
        showMessage("errorMessage", "Please enter a valid email address.");
        return;
      }

      setLoading(true);

      try {
        const response = await fetch('/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: email,
            password: password,
            role: currentRole
          })
        });

        const result = await response.json();

        if (result.status === 'success') {
          currentUserId = result.user_id;
          showMessage("successMessage", result.message);
          
          setTimeout(() => {
            proceedToUserDashboard();
          }, 1500);
        } else {
          showMessage("errorMessage", result.message);
        }
      } catch (error) {
        console.error('Login error:', error);
        showMessage("errorMessage", "Login failed. Please try again.");
      } finally {
        setLoading(false);
      }
    }

    async function handleSignup() {
      isLoginMode = false;
      const email = document.getElementById("email").value.trim();
      const fullName = document.getElementById("fullName").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const password = document.getElementById("password").value;
      const confirmPassword = document.getElementById("confirmPassword").value;

      if (!email || !fullName || !phone || !password || !confirmPassword) {
        showMessage("errorMessage", "Please fill in all fields.");
        return false;
      }

      if (!validateEmail(email)) {
        showMessage("errorMessage", "Please enter a valid email address.");
        return false;
      }

      if (!validatePhoneNumber(phone)) {
        showPhoneError("phone", "phoneError");
        showMessage("errorMessage", "Please enter a valid phone number with numbers only.");
        return false;
      }

      if (!validatePasswords()) {
        return false;
      }

      setLoading(true);

      try {
        const endpoint = `/auth/signup/${currentRole.toLowerCase()}`;
        const response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: fullName,
            email: email,
            phone: phone,
            password: password
          })
        });

        const result = await response.json();

        if (result.status === 'success') {
          currentUserId = result.user_id;
          showMessage("successMessage", result.message);
          
          setTimeout(() => {
            proceedToUserDashboard();
          }, 1500);
        } else {
          showMessage("errorMessage", result.message);
        }
      } catch (error) {
        console.error('Signup error:', error);
        showMessage("errorMessage", "Signup failed. Please try again.");
      } finally {
        setLoading(false);
      }

      return true;
    }

    function proceedToUserDashboard() {
      hideAllMessages();
      
      if (currentRole === "NGO") {
        document.getElementById("ngoFoodGallery").style.display = "block";
        loadFoodForNGO();
      }
      if (currentRole === "Restaurant") {
        document.getElementById("restaurantForm").style.display = "block";
        loadRestaurantFoods();
      }
    }

    // Add real-time validation for phone fields
    document.getElementById("phone").addEventListener("input", function() {
      const originalValue = this.value;
      const sanitizedValue = sanitizePhoneInput(originalValue);
      
      // Show error immediately if alphabets are detected
      if (containsAlphabets(originalValue)) {
        showPhoneError("phone", "phoneError");
      } else {
        hidePhoneError("phone", "phoneError");
      }
      
      // Update the field with sanitized value
      this.value = sanitizedValue;
    });

    document.getElementById("foodContact").addEventListener("input", function() {
      const originalValue = this.value;
      const sanitizedValue = sanitizePhoneInput(originalValue);
      
      // Show error immediately if alphabets are detected
      if (containsAlphabets(originalValue)) {
        showPhoneError("foodContact", "foodContactError");
      } else {
        hidePhoneError("foodContact", "foodContactError");
      }
      
      // Update the field with sanitized value
      this.value = sanitizedValue;
    });

    // Add real-time password validation
    document.getElementById("confirmPassword").addEventListener("input", function() {
      if (this.value !== "" && !isLoginMode) {
        validatePasswords();
      } else {
        hidePasswordError();
      }
    });

    document.getElementById("password").addEventListener("input", function() {
      const confirmPassword = document.getElementById("confirmPassword").value;
      if (confirmPassword !== "" && !isLoginMode) {
        validatePasswords();
      }
    });

    document.getElementById("authForm").addEventListener("submit", function(e) {
      e.preventDefault();
      handleSignup();
    });

    async function addFood() {
      const title = document.getElementById("foodTitle").value.trim();
      const qty = document.getElementById("foodQty").value.trim();
      const pickup = document.getElementById("foodPickup").value.trim();
      const restaurant = document.getElementById("foodRestaurant").value.trim();
      const contact = document.getElementById("foodContact").value.trim();
      const imageUrl = document.getElementById("foodImageUrl").value.trim();

      if (!title || !qty || !pickup || !restaurant || !contact) {
        showMessage("errorMessage", "Please fill all required fields before adding food.");
        return;
      }

      if (!validatePhoneNumber(contact)) {
        showPhoneError("foodContact", "foodContactError");
        showMessage("errorMessage", "Please enter a valid contact number with numbers only.");
        return;
      }

      try {
        const response = await fetch('/auth/food/add', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            title: title,
            quantity: qty,
            pickup: pickup,
            restaurant: restaurant,
            contact: contact,
            image_url: imageUrl
          })
        });

        const result = await response.json();

        if (result.status === 'success') {
          showMessage("successMessage", "Food item added successfully!");
          
          // Clear fields
          document.getElementById("foodTitle").value = "";
          document.getElementById("foodQty").value = "";
          document.getElementById("foodPickup").value = "";
          document.getElementById("foodRestaurant").value = "";
          document.getElementById("foodContact").value = "";
          document.getElementById("foodImageUrl").value = "";
          hidePhoneError("foodContact", "foodContactError");

          // Refresh food list
          setTimeout(() => {
            loadRestaurantFoods();
          }, 1000);
        } else {
          showMessage("errorMessage", result.message);
        }
      } catch (error) {
        console.error('Add food error:', error);
        showMessage("errorMessage", "Failed to add food item. Please try again.");
      }
    }

    async function loadFoodForNGO() {
      try {
        const response = await fetch('/auth/food/available');
        const result = await response.json();

        const container = document.getElementById("ngoGalleryList");
        container.innerHTML = "";

        if (result.status === 'success' && result.foods.length > 0) {
          result.foods.forEach(food => {
            const div = document.createElement("div");
            div.classList.add("food-card");
            div.innerHTML = `
              ${food.image_url ? `<img src="${food.image_url}" alt="${food.title}" onerror="this.style.display='none'">` : ''}
              <h3>${capitalizeFirst(food.title)}</h3>
              <p class="quantity">${food.quantity}</p>
              <p class="location">üìç ${capitalizeFirst(food.pickup)}</p>
              <p class="contact">üè™ ${food.restaurant}</p>
              <p class="contact">üìû ${food.contact}</p>
            `;
            container.appendChild(div);
          });
        } else {
          container.innerHTML = '<div class="no-food-message">No food available at the moment. Please check back later.</div>';
        }
      } catch (error) {
        console.error('Load foods error:', error);
        document.getElementById("ngoGalleryList").innerHTML = '<div class="no-food-message">Failed to load available foods.</div>';
      }
    }

    async function loadRestaurantFoods() {
      try {
        const response = await fetch('/auth/food/my-foods');
        const result = await response.json();

        const container = document.getElementById("restaurantFoodList");
        container.innerHTML = "";

        if (result.status === 'success' && result.foods.length > 0) {
          result.foods.forEach(food => {
            const div = document.createElement("div");
            div.classList.add("food-card");
            div.innerHTML = `
              ${food.image_url ? `<img src="${food.image_url}" alt="${food.title}" onerror="this.style.display='none'">` : ''}
              <h3>${capitalizeFirst(food.title)}</h3>
              <p class="quantity">${food.quantity}</p>
              <p class="location">üìç ${capitalizeFirst(food.pickup)}</p>
              <p class="contact">üè™ ${food.restaurant}</p>
              <p class="contact">üìû ${food.contact}</p>
            `;
            container.appendChild(div);
          });
        } else {
          container.innerHTML = '<div class="no-food-message">No food items added yet.</div>';
        }
      } catch (error) {
        console.error('Load restaurant foods error:', error);
        document.getElementById("restaurantFoodList").innerHTML = '<div class="no-food-message">Failed to load your food items.</div>';
      }
    }

    function capitalizeFirst(str) {
      return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
    }
  </script>
</body>
</html>